<!DOCTYPE html>
<html lang="en-US">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chalet Reservation</title>
  <style>
    body {
      font-family: "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(135deg, #e0f7fa, #f1f8e9);
      margin: 0;
      padding: 0;
      color: #2c3e50;
    }
    header {
      background: linear-gradient(90deg, #43a047, #2e7d32);
      color: white;
      padding: 1.5rem;
      text-align: center;
      box-shadow: 0 3px 8px rgba(0,0,0,0.2);
    }
    header h1 {
      margin: 0;
      font-size: 1.8rem;
    }
    .container {
      max-width: 900px;
      margin: 25px auto;
      padding: 24px;
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    }
    h2, h3 {
      margin-bottom: 12px;
      color: #2e7d32;
    }
    #calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px;
      margin-top: 10px;
    }
    .dow {
      font-weight: bold;
      text-align: center;
      padding: 6px;
      background: #f1f8e9;
      border-radius: 6px;
    }
    .day {
      padding: 12px;
      border-radius: 10px;
      min-height: 80px;
      text-align: center;
      font-size: 14px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }
    .day:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    .day.empty { background: transparent; box-shadow: none; cursor: default; }
    .day.available { background: #e8f5e9; border: 1px solid #c8e6c9; cursor: pointer; }
    .day.booked { background: #ffebee; border: 1px solid #ef9a9a; color: #c62828; cursor: not-allowed; }
    .day.today { border: 2px solid #43a047; }
    .num { font-weight: bold; font-size: 16px; }
    .resv-name { margin-top: 6px; font-size: 13px; color: #555; font-style: italic; }
    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      transition: background 0.2s, transform 0.1s;
    }
    .btn:hover { transform: scale(1.05); }
    .btn.primary { background: #43a047; color: white; }
    .btn.primary:hover { background: #2e7d32; }
    .btn.danger { background: #e53935; color: white; }
    .btn.danger:hover { background: #c62828; }
    .btn.light { background: #f1f1f1; }
    .btn.light:hover { background: #e0e0e0; }
    .actions { display: flex; gap: 10px; margin-top: 12px; flex-wrap: wrap; }
    .form-grid { display: grid; gap: 16px; margin-top: 10px; }
    input {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 15px;
    }
    input:focus { border-color: #43a047; outline: none; box-shadow: 0 0 4px rgba(67,160,71,0.4); }
    .reservation-item {
      border: 1px solid #ddd;
      padding: 12px;
      margin-bottom: 10px;
      border-radius: 10px;
      background: #fafafa;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    #confirmationModal {
      display: none; position: fixed; z-index: 1000;
      left: 0; top: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.4);
    }
    #confirmationModal .modal-content {
      background: white;
      margin: 15% auto;
      padding: 20px;
      border-radius: 14px;
      width: 90%;
      max-width: 400px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    #confirmationModal .close {
      float: right;
      font-size: 22px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <header>
    <h1>üåø Chalet Reservation System</h1>
  </header>

  <div class="container">
    <h2 id="monthDisplay"></h2>
    <div class="actions">
      <button id="prevBtn" class="btn light">‚üµ Prev</button>
      <button id="todayBtn" class="btn primary">Today</button>
      <button id="nextBtn" class="btn light">Next ‚ü∂</button>
    </div>
    <div id="calendar"></div>
  </div>

  <div class="container" id="reserve">
    <h2>üìÖ Book a Reservation</h2>
    <form id="reservationForm">
      <div class="form-grid">
        <div>
          <label for="name">Your Name</label>
          <input type="text" id="name" name="name" required />
        </div>
        <div>
          <label for="checkin">Date</label>
          <input type="date" id="checkin" name="checkin" required />
        </div>
      </div>
      <div class="actions">
        <button type="submit" class="btn primary">Reserve</button>
      </div>
    </form>
  </div>

  <div class="container">
    <h2>üîç Find Your Reservation</h2>
    <div class="form-grid">
      <input type="text" id="searchName" placeholder="Enter your name" />
      <button id="searchBtn" class="btn primary">Search</button>
    </div>
    <div id="reservationResults" style="margin-top:12px;"></div>
  </div>

  <div id="confirmationModal">
    <div class="modal-content">
      <span id="closeModalBtn" class="close">&times;</span>
      <h3>üéâ Reservation Confirmed!</h3>
      <div id="bookingDetails"></div>
    </div>
  </div>

  <script>
    // ‚úÖ Your Render backend URL
    const API_BASE = "https://chaletf.onrender.com";

    let reservations = {}; 
    let current = new Date();

    async function fetchReservations() {
      try {
        const res = await fetch(`${API_BASE}/api/reservations`);
        reservations = res.ok ? await res.json() : {};
      } catch (err) {
        console.warn("‚ö†Ô∏è API not available, showing empty calendar", err);
        reservations = {};
      }
    }

    async function createReservation(name, date) {
      const res = await fetch(`${API_BASE}/api/reservations`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name, date })
      });
      return res.json();
    }

    async function deleteReservation(date) {
      const res = await fetch(`${API_BASE}/api/reservations/${date}`, { method: "DELETE" });
      return res.json();
    }

    async function searchReservations(query) {
      const res = await fetch(`${API_BASE}/api/reservations/search?name=${encodeURIComponent(query)}`);
      return res.json();
    }

    function pad(n){ return String(n).padStart(2,'0'); }
    function ymd(d){ return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }

    function buildCalendar(date) {
      const calendar = document.getElementById('calendar');
      const monthDisplay = document.getElementById('monthDisplay');
      calendar.innerHTML = '';

      const year = date.getFullYear();
      const month = date.getMonth();
      const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
      const dow = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
      monthDisplay.textContent = `${monthNames[month]} ${year}`;

      dow.forEach(d => {
        const h = document.createElement('div');
        h.className = 'dow';
        h.textContent = d;
        calendar.appendChild(h);
      });

      const first = new Date(year, month, 1);
      const startOffset = first.getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();

      for (let i = 0; i < startOffset; i++) {
        const e = document.createElement('div');
        e.className = 'day empty';
        calendar.appendChild(e);
      }

      const today = new Date(); today.setHours(0,0,0,0);

      for (let day = 1; day <= daysInMonth; day++) {
        const cell = document.createElement('div');
        cell.className = 'day';
        const num = document.createElement('div');
        num.className = 'num';
        num.textContent = day;
        cell.appendChild(num);

        const thisDate = new Date(year, month, day);
        const key = ymd(thisDate);

        if (reservations[key]) {
          cell.classList.add('booked');
          const nameEl = document.createElement('div');
          nameEl.className = 'resv-name';
          nameEl.textContent = reservations[key].name;
          cell.appendChild(nameEl);
          cell.title = `Reserved by: ${reservations[key].name}`;
        } else {
          cell.classList.add('available');
          if (thisDate >= today) {
            cell.addEventListener('click', () => {
              const input = document.getElementById('checkin');
              input.value = key;
              document.getElementById('reserve').scrollIntoView({ behavior: 'smooth', block: 'start' });
            });
          } else {
            cell.classList.remove('available');
            cell.style.background = '#f1f1f1';
            cell.style.color = '#9aa0a6';
            cell.style.cursor = 'not-allowed';
            cell.title = 'Past date';
          }
        }
        if (ymd(thisDate) === ymd(today)) cell.classList.add('today');
        calendar.appendChild(cell);
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      await fetchReservations();
      const dateInput = document.getElementById('checkin');
      const todayStr = new Date().toISOString().split('T')[0];
      dateInput.min = todayStr;

      document.getElementById('prevBtn').addEventListener('click', () => { current.setMonth(current.getMonth() - 1); buildCalendar(current); });
      document.getElementById('nextBtn').addEventListener('click', () => { current.setMonth(current.getMonth() + 1); buildCalendar(current); });
      document.getElementById('todayBtn').addEventListener('click', () => { current = new Date(); buildCalendar(current); });

      buildCalendar(current);

      document.getElementById('reservationForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const form = e.currentTarget;
        const name = form.name.value.trim();
        const checkin = form.checkin.value;
        if (!name || !checkin) return alert('Please complete the form.');
        if (reservations[checkin]) return alert('This date is already reserved.');
        const resp = await createReservation(name, checkin);
        if (resp.error) return alert(resp.error);
        await fetchReservations();
        buildCalendar(current);
        alert("üéâ Reservation confirmed!");
        form.reset();
      });

      document.getElementById('searchBtn').addEventListener('click', async () => {
        const q = document.getElementById('searchName').value.trim();
        if (!q) return alert('Please enter a name to search.');
        const found = await searchReservations(q);
        const resultsDiv = document.getElementById('reservationResults');
        if (!Object.keys(found).length) {
          resultsDiv.innerHTML = "<p style='color:#666'>No reservations found.</p>";
          return;
        }
        let html = '';
        Object.entries(found).forEach(([dateString, reservation]) => {
          const formatted = new Date(dateString).toLocaleDateString(undefined, { weekday:'long', year:'numeric', month:'long', day:'numeric' });
          html += `
            <div class="reservation-item">
              <div><strong>Name:</strong> ${reservation.name}</div>
              <div><strong>Date:</strong> ${formatted}</div>
              <div class="actions"><button class="btn danger" onclick="cancelReservation('${dateString}')">Cancel</button></div>
            </div>`;
        });
        resultsDiv.innerHTML = html;
      });
    });

    window.cancelReservation = async function(dateString){
      if (!reservations[dateString]) return alert('Reservation not found.');
      if (confirm('Cancel this reservation?')) {
        await deleteReservation(dateString);
        await fetchReservations();
        buildCalendar(current);
        document.getElementById('reservationResults').innerHTML = '<p style="color:#16a34a">Reservation cancelled. Search again to refresh.</p>';
      }
    }
  </script>
</body>
</html>
