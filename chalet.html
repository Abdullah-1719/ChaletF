<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>الجوهرة - Chalet Reservation</title>
  <style>
    :root {
      --primary: #1a1a1a;
      --primary-hover: #000000;
      --secondary: #f5f5f5;
      --accent: #404040;
      --success: #2a2a2a;
      --danger: #1a1a1a;
      --warning: #333333;
      --background: #000000;
      --surface: #1a1a1a;
      --surface-light: #2a2a2a;
      --text-primary: #ffffff;
      --text-secondary: #cccccc;
      --text-muted: #888888;
      --border: #404040;
      --shadow: rgba(0, 0, 0, 0.5);
      --shadow-lg: rgba(0, 0, 0, 0.8);
    }
    * { box-sizing: border-box; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(135deg, var(--background) 0%, #111111 100%);
      margin: 0; padding: 0;
      color: var(--text-primary);
      line-height: 1.6;
      min-height: 100vh;
    }
    header {
      background: linear-gradient(135deg, #000000 0%, #1a1a1a 50%, #2a2a2a 100%);
      color: white;
      padding: 3rem 2rem;
      text-align: center;
      box-shadow: 0 8px 32px var(--shadow-lg);
      position: relative;
    }
    header h1 {
      margin: 0;
      font-size: 3rem;
      font-weight: 700;
      letter-spacing: 2px;
      position: relative;
      z-index: 1;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
    }
    .container {
      max-width: 1000px;
      margin: 2rem auto;
      padding: 2rem;
      background: rgba(26, 26, 26, 0.9);
      border-radius: 24px;
      box-shadow: 0 20px 40px var(--shadow-lg);
      position: relative;
    }
    h2 { margin-bottom: 1.5rem; color: var(--text-primary); font-size: 1.75rem; border-bottom: 2px solid var(--accent); }
    #calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 0.75rem;
      margin-top: 1.5rem;
      padding: 1rem;
      background: rgba(42, 42, 42, 0.4);
      border-radius: 16px;
    }
    .dow {
      font-weight: 600;
      text-align: center;
      padding: 1rem 0.5rem;
      background: linear-gradient(135deg, var(--surface-light), var(--surface));
      border-radius: 12px;
      color: var(--text-secondary);
      font-size: 0.875rem;
      text-transform: uppercase;
    }
    .day {
      padding: 1rem;
      border-radius: 16px;
      min-height: 100px;
      text-align: center;
      font-size: 0.875rem;
      background: linear-gradient(135deg, var(--surface), var(--surface-light));
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: all 0.3s;
    }
    .day.empty { background: transparent; border: none; }
    .day.available { background: linear-gradient(135deg, var(--surface), var(--surface-light)); cursor: pointer; }
    .day.booked { background: #333; color: var(--text-muted); cursor: not-allowed; }
    .day.today { border: 2px solid var(--accent); }
    .num { font-weight: 700; font-size: 1.125rem; margin-bottom: 0.5rem; }
    .resv-name { font-size: 0.75rem; color: var(--text-muted); font-style: italic; }
    .btn { padding: 0.875rem 1.5rem; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; }
    .btn.primary { background: linear-gradient(135deg, var(--primary), var(--primary-hover)); color: white; }
    .btn.light { background: linear-gradient(135deg, var(--surface-light), var(--surface)); color: var(--text-secondary); }
    .actions { display: flex; gap: 1rem; margin-top: 1.5rem; flex-wrap: wrap; }
  </style>
</head>
<body>
  <header>
    <h1>الجوهرة</h1>
  </header>

  <div class="container">
    <h2 id="monthDisplay"></h2>
    <div class="actions">
      <button id="prevBtn" class="btn light">⟵ السابق</button>
      <button id="todayBtn" class="btn primary">اليوم</button>
      <button id="nextBtn" class="btn light">التالي ⟶</button>
    </div>
    <div id="calendar"></div>
  </div>

  <div class="container" id="reserve">
    <h2>📅 حجز جديد</h2>
    <form id="reservationForm">
      <div class="form-grid">
        <div>
          <label for="name">الاسم</label>
          <input type="text" id="name" name="name" required />
        </div>
        <div>
          <label for="checkin">التاريخ</label>
          <input type="date" id="checkin" name="checkin" required />
        </div>
      </div>
      <div class="actions">
        <button type="submit" class="btn primary">احجز الآن</button>
      </div>
    </form>
  </div>

  <div class="container">
    <h2>🔍 البحث عن الحجز</h2>
    <div class="form-grid">
      <input type="text" id="searchName" placeholder="اكتب اسمك" />
      <button id="searchBtn" class="btn primary">ابحث</button>
    </div>
    <div id="reservationResults" style="margin-top:12px;"></div>
  </div>

  <div id="confirmationModal" style="display:none;">
    <div class="modal-content">
      <span id="closeModalBtn" class="close">&times;</span>
      <h3>✅ تم تأكيد الحجز</h3>
      <div id="bookingDetails"></div>
    </div>
  </div>

  <script>
    let reservations = {}; 
    let current = new Date();

    async function fetchReservations() {
      try {
        const res = await fetch("/api/reservations");
        if (res.ok) {
          reservations = await res.json();
        } else {
          reservations = {};
        }
      } catch (err) {
        console.warn("⚠️ لم يتم الاتصال بالخادم، عرض التواريخ فارغة");
        reservations = {};
      }
    }

    function pad(n){ return String(n).padStart(2,'0'); }
    function ymd(d){ return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }

    function buildCalendar(date) {
      const calendar = document.getElementById('calendar');
      const monthDisplay = document.getElementById('monthDisplay');
      calendar.innerHTML = '';

      const year = date.getFullYear();
      const month = date.getMonth();
      const monthNames = ['يناير','فبراير','مارس','أبريل','مايو','يونيو','يوليو','أغسطس','سبتمبر','أكتوبر','نوفمبر','ديسمبر'];
      const dow = ['أحد','اثنين','ثلاثاء','أربعاء','خميس','جمعة','سبت'];
      monthDisplay.textContent = `${monthNames[month]} ${year}`;

      dow.forEach(d => {
        const h = document.createElement('div');
        h.className = 'dow';
        h.textContent = d;
        calendar.appendChild(h);
      });

      const first = new Date(year, month, 1);
      const startOffset = first.getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();

      for (let i = 0; i < startOffset; i++) {
        const e = document.createElement('div');
        e.className = 'day empty';
        calendar.appendChild(e);
      }

      const today = new Date(); today.setHours(0,0,0,0);

      for (let day = 1; day <= daysInMonth; day++) {
        const cell = document.createElement('div');
        cell.className = 'day';
        const num = document.createElement('div');
        num.className = 'num';
        num.textContent = day;
        cell.appendChild(num);

        const thisDate = new Date(year, month, day);
        const key = ymd(thisDate);

        if (reservations[key]) {
          cell.classList.add('booked');
          const nameEl = document.createElement('div');
          nameEl.className = 'resv-name';
          nameEl.textContent = reservations[key].name;
          cell.appendChild(nameEl);
          cell.title = `محجوز بواسطة: ${reservations[key].name}`;
        } else {
          cell.classList.add('available');
          if (thisDate < today) {
            cell.classList.remove('available');
            cell.style.background = '#1c1c1c';
            cell.style.color = '#777';
            cell.style.cursor = 'not-allowed';
            cell.title = 'تاريخ قديم';
          }
        }
        if (ymd(thisDate) === ymd(today)) cell.classList.add('today');
        calendar.appendChild(cell);
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      await fetchReservations();   // ✅ آمنة الآن
      buildCalendar(current);      // ✅ دايمًا يرسم الكالندر

      document.getElementById('prevBtn').addEventListener('click', () => {
        current.setMonth(current.getMonth() - 1);
        buildCalendar(current);
      });
      document.getElementById('nextBtn').addEventListener('click', () => {
        current.setMonth(current.getMonth() + 1);
        buildCalendar(current);
      });
      document.getElementById('todayBtn').addEventListener('click', () => {
        current = new Date();
        buildCalendar(current);
      });
    });
  </script>
</body>
</html>
