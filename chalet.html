<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>الجوهرة - Chalet Reservation</title>
  <style>
    :root {
      --primary: #1a1a1a;
      --primary-hover: #000000;
      --secondary: #f5f5f5;
      --accent: #404040;
      --accent-light: #606060;
      --success: #2a2a2a;
      --danger: #1a1a1a;
      --warning: #333333;
      --background: #000000;
      --surface: #1a1a1a;
      --surface-light: #2a2a2a;
      --surface-lighter: #3a3a3a;
      --text-primary: #ffffff;
      --text-secondary: #cccccc;
      --text-muted: #888888;
      --border: #404040;
      --shadow: rgba(0, 0, 0, 0.5);
      --shadow-lg: rgba(0, 0, 0, 0.8);
      --glow: rgba(255, 255, 255, 0.1);
      --glow-strong: rgba(255, 255, 255, 0.2);
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: 
        radial-gradient(circle at 20% 80%, rgba(26, 26, 26, 0.8) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(42, 42, 42, 0.6) 0%, transparent 50%),
        linear-gradient(135deg, var(--background) 0%, #111111 50%, #0a0a0a 100%);
      margin: 0;
      padding: 0;
      color: var(--text-primary);
      line-height: 1.6;
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
    }

    /* Added animated background pattern */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        repeating-linear-gradient(
          45deg,
          transparent,
          transparent 2px,
          rgba(255, 255, 255, 0.01) 2px,
          rgba(255, 255, 255, 0.01) 4px
        ),
        repeating-linear-gradient(
          -45deg,
          transparent,
          transparent 2px,
          rgba(255, 255, 255, 0.005) 2px,
          rgba(255, 255, 255, 0.005) 4px
        );
      pointer-events: none;
      z-index: -1;
      animation: patternMove 20s linear infinite;
    }

    @keyframes patternMove {
      0% { transform: translate(0, 0); }
      100% { transform: translate(50px, 50px); }
    }

    header {
      background: 
        linear-gradient(135deg, rgba(0, 0, 0, 0.95) 0%, rgba(26, 26, 26, 0.9) 50%, rgba(42, 42, 42, 0.85) 100%),
        url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200"><defs><pattern id="hexagons" width="50" height="43.4" patternUnits="userSpaceOnUse"><polygon points="25,0 50,14.4 50,28.9 25,43.4 0,28.9 0,14.4" fill="none" stroke="rgba(255,255,255,0.03)" stroke-width="0.5"/></pattern></defs><rect width="200" height="200" fill="url(%23hexagons)"/></svg>');
      color: white;
      padding: 4rem 2rem;
      text-align: center;
      box-shadow: 
        0 8px 32px var(--shadow-lg),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(20px);
    }

    /* Enhanced header glow effect */
    header::after {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: 
        radial-gradient(circle, rgba(255, 255, 255, 0.05) 0%, transparent 70%);
      animation: headerGlow 8s ease-in-out infinite alternate;
      pointer-events: none;
    }

    @keyframes headerGlow {
      0% { opacity: 0.3; transform: scale(0.8); }
      100% { opacity: 0.6; transform: scale(1.2); }
    }

    header h1 {
      margin: 0;
      font-size: 3.5rem;
      font-weight: 800;
      letter-spacing: 3px;
      position: relative;
      z-index: 2;
      text-shadow: 
        0 2px 4px rgba(0, 0, 0, 0.8),
        0 0 20px rgba(255, 255, 255, 0.1),
        0 0 40px rgba(255, 255, 255, 0.05);
      background: linear-gradient(135deg, #ffffff 0%, #e0e0e0 50%, #ffffff 100%);
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: titleShimmer 3s ease-in-out infinite alternate;
    }

    @keyframes titleShimmer {
      0% { filter: brightness(1) drop-shadow(0 0 10px rgba(255, 255, 255, 0.1)); }
      100% { filter: brightness(1.1) drop-shadow(0 0 20px rgba(255, 255, 255, 0.2)); }
    }

    .container {
      max-width: 1000px;
      margin: 2rem auto;
      padding: 2.5rem;
      background: 
        linear-gradient(135deg, rgba(26, 26, 26, 0.95) 0%, rgba(42, 42, 42, 0.9) 100%),
        url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="dots" width="20" height="20" patternUnits="userSpaceOnUse"><circle cx="10" cy="10" r="1" fill="rgba(255,255,255,0.02)"/></pattern></defs><rect width="100" height="100" fill="url(%23dots)"/></svg>');
      backdrop-filter: blur(25px);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 28px;
      box-shadow: 
        0 25px 50px var(--shadow-lg),
        inset 0 1px 0 rgba(255, 255, 255, 0.1),
        0 0 0 1px rgba(255, 255, 255, 0.05);
      position: relative;
      animation: fadeInUp 0.8s cubic-bezier(0.4, 0, 0.2, 1);
      overflow: hidden;
    }

    /* Added floating particles effect */
    .container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, 
        transparent 0%, 
        rgba(255, 255, 255, 0.1) 20%, 
        rgba(255, 255, 255, 0.4) 50%, 
        rgba(255, 255, 255, 0.1) 80%, 
        transparent 100%);
      animation: borderGlow 2s ease-in-out infinite alternate;
    }

    @keyframes borderGlow {
      0% { opacity: 0.5; }
      100% { opacity: 1; }
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    h2, h3 {
      margin-bottom: 1.5rem;
      color: var(--text-primary);
      font-weight: 700;
      position: relative;
      padding-bottom: 1rem;
    }

    h2 {
      font-size: 2rem;
      border-bottom: 3px solid;
      border-image: linear-gradient(90deg, var(--accent), var(--accent-light), transparent) 1;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    h3 {
      font-size: 1.5rem;
      border-bottom: 2px solid var(--border);
    }

    #calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 1rem;
      margin-top: 2rem;
      padding: 1.5rem;
      background: 
        linear-gradient(135deg, rgba(42, 42, 42, 0.6) 0%, rgba(26, 26, 26, 0.8) 100%);
      border-radius: 20px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 
        inset 0 1px 0 rgba(255, 255, 255, 0.1),
        0 10px 20px rgba(0, 0, 0, 0.3);
      position: relative;
      overflow: hidden;
    }

    /* Added calendar background animation */
    #calendar::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: 
        radial-gradient(circle, rgba(255, 255, 255, 0.02) 0%, transparent 50%);
      animation: calendarPulse 6s ease-in-out infinite;
      pointer-events: none;
    }

    @keyframes calendarPulse {
      0%, 100% { opacity: 0.3; transform: scale(0.8) rotate(0deg); }
      50% { opacity: 0.6; transform: scale(1.2) rotate(180deg); }
    }

    .dow {
      font-weight: 700;
      text-align: center;
      padding: 1.25rem 0.75rem;
      background: linear-gradient(135deg, var(--surface-lighter), var(--surface-light));
      border-radius: 16px;
      color: var(--text-secondary);
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 
        0 4px 8px rgba(0, 0, 0, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
      position: relative;
      z-index: 1;
    }

    .day {
      padding: 1.25rem;
      border-radius: 20px;
      min-height: 110px;
      text-align: center;
      font-size: 0.875rem;
      background: linear-gradient(135deg, var(--surface) 0%, var(--surface-light) 100%);
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      z-index: 1;
    }

    /* Enhanced day hover effects with multiple layers */
    .day::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, 
        transparent, 
        rgba(255, 255, 255, 0.1), 
        rgba(255, 255, 255, 0.2), 
        rgba(255, 255, 255, 0.1), 
        transparent);
      transition: left 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .day::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
      border-radius: 50%;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      transform: translate(-50%, -50%);
    }

    .day:hover::before {
      left: 100%;
    }

    .day:hover::after {
      width: 200px;
      height: 200px;
    }

    .day:hover {
      transform: translateY(-6px) scale(1.05);
      box-shadow: 
        0 15px 30px var(--shadow-lg),
        0 0 20px rgba(255, 255, 255, 0.1);
      border-color: var(--accent-light);
      background: linear-gradient(135deg, var(--surface-light) 0%, var(--surface-lighter) 100%);
    }

    .day.empty {
      background: transparent;
      box-shadow: none;
      cursor: default;
      border: none;
    }

    .day.empty:hover {
      transform: none;
    }

    .day.empty::before,
    .day.empty::after {
      display: none;
    }

    .day.available {
      background: linear-gradient(135deg, var(--surface) 0%, var(--surface-light) 100%);
      color: var(--text-primary);
      cursor: pointer;
    }

    .day.available:hover {
      background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
      color: white;
      box-shadow: 
        0 15px 30px var(--shadow-lg),
        0 0 25px rgba(64, 64, 64, 0.4);
    }

    .day.booked {
      background: linear-gradient(135deg, #2a2a2a 0%, #404040 100%);
      color: var(--text-muted);
      cursor: not-allowed;
      position: relative;
    }

    .day.booked::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 15%;
      right: 15%;
      height: 3px;
      background: linear-gradient(90deg, transparent, var(--primary), transparent);
      transform: translateY(-50%);
      border-radius: 2px;
    }

    .day.today {
      border: 3px solid var(--accent-light);
      box-shadow: 
        0 0 25px rgba(64, 64, 64, 0.6),
        inset 0 0 20px rgba(255, 255, 255, 0.05);
      animation: todayPulse 2s ease-in-out infinite;
    }

    @keyframes todayPulse {
      0%, 100% { box-shadow: 0 0 25px rgba(64, 64, 64, 0.6), inset 0 0 20px rgba(255, 255, 255, 0.05); }
      50% { box-shadow: 0 0 35px rgba(64, 64, 64, 0.8), inset 0 0 30px rgba(255, 255, 255, 0.1); }
    }

    .num {
      font-weight: 800;
      font-size: 1.25rem;
      margin-bottom: 0.5rem;
      position: relative;
      z-index: 2;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }

    .resv-name {
      margin-top: 0.5rem;
      font-size: 0.75rem;
      color: var(--text-muted);
      font-style: italic;
      position: relative;
      z-index: 2;
    }

    .btn {
      padding: 1rem 2rem;
      border: none;
      border-radius: 16px;
      cursor: pointer;
      font-weight: 700;
      font-size: 0.875rem;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      text-transform: uppercase;
      letter-spacing: 1px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    /* Enhanced button effects with multiple animation layers */
    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, 
        transparent, 
        rgba(255, 255, 255, 0.2), 
        rgba(255, 255, 255, 0.4), 
        rgba(255, 255, 255, 0.2), 
        transparent);
      transition: left 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .btn::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      transform: translate(-50%, -50%);
    }

    .btn:hover::before {
      left: 100%;
    }

    .btn:hover::after {
      width: 300px;
      height: 300px;
    }

    .btn.primary {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-hover) 50%, var(--primary) 100%);
      color: white;
      box-shadow: 
        0 6px 16px rgba(26, 26, 26, 0.6),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }

    .btn.primary:hover {
      transform: translateY(-3px) scale(1.02);
      box-shadow: 
        0 12px 24px rgba(26, 26, 26, 0.8),
        0 0 20px rgba(255, 255, 255, 0.1);
    }

    .btn.danger {
      background: linear-gradient(135deg, var(--danger) 0%, #333333 50%, var(--danger) 100%);
      color: white;
      box-shadow: 
        0 6px 16px rgba(26, 26, 26, 0.6),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }

    .btn.danger:hover {
      transform: translateY(-3px) scale(1.02);
      box-shadow: 
        0 12px 24px rgba(26, 26, 26, 0.8),
        0 0 20px rgba(255, 255, 255, 0.1);
    }

    .btn.light {
      background: linear-gradient(135deg, var(--surface-light) 0%, var(--surface) 50%, var(--surface-light) 100%);
      color: var(--text-secondary);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .btn.light:hover {
      background: linear-gradient(135deg, var(--surface) 0%, var(--accent) 50%, var(--surface) 100%);
      color: white;
      transform: translateY(-3px) scale(1.02);
      box-shadow: 
        0 12px 24px rgba(0, 0, 0, 0.4),
        0 0 20px rgba(255, 255, 255, 0.1);
    }

    .actions {
      display: flex;
      gap: 1.25rem;
      margin-top: 2rem;
      flex-wrap: wrap;
    }

    .form-grid {
      display: grid;
      gap: 2rem;
      margin-top: 1.5rem;
    }

    label {
      display: block;
      margin-bottom: 0.75rem;
      font-weight: 700;
      color: var(--text-secondary);
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    input {
      width: 100%;
      padding: 1.25rem 1.5rem;
      border-radius: 16px;
      border: 2px solid var(--border);
      font-size: 1rem;
      background: 
        linear-gradient(135deg, rgba(26, 26, 26, 0.9) 0%, rgba(42, 42, 42, 0.8) 100%);
      color: var(--text-primary);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      backdrop-filter: blur(10px);
      box-shadow: 
        inset 0 2px 4px rgba(0, 0, 0, 0.3),
        0 1px 0 rgba(255, 255, 255, 0.1);
    }

    input:focus {
      border-color: var(--accent-light);
      outline: none;
      box-shadow: 
        0 0 0 4px rgba(64, 64, 64, 0.3),
        inset 0 2px 4px rgba(0, 0, 0, 0.3),
        0 1px 0 rgba(255, 255, 255, 0.1);
      background: 
        linear-gradient(135deg, rgba(26, 26, 26, 0.95) 0%, rgba(42, 42, 42, 0.9) 100%);
      transform: translateY(-1px);
    }

    input::placeholder {
      color: var(--text-muted);
    }

    .reservation-item {
      border: 1px solid rgba(255, 255, 255, 0.15);
      padding: 2rem;
      margin-bottom: 1.5rem;
      border-radius: 20px;
      background: 
        linear-gradient(135deg, rgba(42, 42, 42, 0.9) 0%, rgba(26, 26, 26, 0.9) 100%);
      backdrop-filter: blur(15px);
      box-shadow: 
        0 10px 20px var(--shadow),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .reservation-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, transparent, var(--accent), transparent);
      opacity: 0;
      transition: opacity 0.4s ease;
    }

    .reservation-item:hover {
      transform: translateY(-4px) scale(1.01);
      box-shadow: 
        0 20px 40px var(--shadow-lg),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
      border-color: var(--accent);
    }

    .reservation-item:hover::before {
      opacity: 1;
    }

    #confirmationModal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(12px);
    }

    #confirmationModal .modal-content {
      background: 
        linear-gradient(135deg, var(--surface) 0%, var(--surface-light) 100%);
      margin: 8% auto;
      padding: 3rem;
      border-radius: 28px;
      width: 90%;
      max-width: 500px;
      text-align: center;
      color: var(--text-primary);
      box-shadow: 
        0 30px 60px var(--shadow-lg),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.15);
      position: relative;
      animation: modalSlideIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      overflow: hidden;
    }

    /* Enhanced modal animation */
    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-100px) scale(0.8) rotateX(15deg);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1) rotateX(0deg);
      }
    }

    #confirmationModal .close {
      position: absolute;
      top: 1.5rem;
      right: 2rem;
      font-size: 1.75rem;
      cursor: pointer;
      color: var(--text-muted);
      transition: all 0.3s ease;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.05);
    }

    #confirmationModal .close:hover {
      color: var(--text-primary);
      background: rgba(255, 255, 255, 0.1);
      transform: scale(1.1);
    }

    @media (max-width: 768px) {
      .container {
        margin: 1rem;
        padding: 2rem;
      }

      header h1 {
        font-size: 2.5rem;
      }

      #calendar {
        gap: 0.75rem;
        padding: 1rem;
      }

      .day {
        min-height: 90px;
        padding: 1rem;
      }

      .actions {
        flex-direction: column;
      }

      .btn {
        width: 100%;
      }
    }

    /* Enhanced scrollbar styling */
    ::-webkit-scrollbar {
      width: 12px;
    }

    ::-webkit-scrollbar-track {
      background: var(--background);
      border-radius: 6px;
    }

    ::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, var(--primary), var(--accent));
      border-radius: 6px;
      border: 2px solid var(--background);
    }

    ::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(135deg, var(--primary-hover), var(--accent-light));
    }
  </style>
</head>
<body>
  <header>
    <h1>الجوهرة</h1>
  </header>

  <div class="container">
    <h2 id="monthDisplay"></h2>
    <div class="actions">
      <button id="prevBtn" class="btn light">⟵ السابق</button>
      <button id="todayBtn" class="btn primary">اليوم</button>
      <button id="nextBtn" class="btn light">التالي ⟶</button>
    </div>
    <div id="calendar"></div>
  </div>

  <div class="container" id="reserve">
    <h2>📅 حجز جديد</h2>
    <form id="reservationForm">
      <div class="form-grid">
        <div>
          <label for="name">الاسم</label>
          <input type="text" id="name" name="name" required />
        </div>
        <div>
          <label for="checkin">التاريخ</label>
          <input type="date" id="checkin" name="checkin" required />
        </div>
      </div>
      <div class="actions">
        <button type="submit" class="btn primary">احجز الآن</button>
      </div>
    </form>
  </div>

  <div class="container">
    <h2>🔍 البحث عن الحجز</h2>
    <div class="form-grid">
      <input type="text" id="searchName" placeholder="اكتب اسمك" />
      <button id="searchBtn" class="btn primary">ابحث</button>
    </div>
    <div id="reservationResults" style="margin-top:12px;"></div>
  </div>

  <div id="confirmationModal">
    <div class="modal-content">
      <span id="closeModalBtn" class="close">&times;</span>
      <h3>✅ تم تأكيد الحجز</h3>
      <div id="bookingDetails"></div>
    </div>
  </div>

  <script>
    let reservations = {}; 
    let current = new Date();

    async function fetchReservations() {
      const res = await fetch("/api/reservations");
      reservations = await res.json();
    }
    async function createReservation(name, date) {
      const res = await fetch("/api/reservations", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name, date })
      });
      return res.json();
    }
    async function deleteReservation(date) {
      const res = await fetch(`/api/reservations/${date}`, { method: "DELETE" });
      return res.json();
    }
    async function searchReservations(query) {
      const res = await fetch(`/api/reservations/search?name=${encodeURIComponent(query)}`);
      return res.json();
    }
    function pad(n){ return String(n).padStart(2,'0'); }
    function ymd(d){ return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }

    function buildCalendar(date) {
      const calendar = document.getElementById('calendar');
      const monthDisplay = document.getElementById('monthDisplay');
      calendar.innerHTML = '';

      const year = date.getFullYear();
      const month = date.getMonth();
      const monthNames = ['يناير','فبراير','مارس','أبريل','مايو','يونيو','يوليو','أغسطس','سبتمبر','أكتوبر','نوفمبر','ديسمبر'];
      const dow = ['أحد','اثنين','ثلاثاء','أربعاء','خميس','جمعة','سبت'];
      monthDisplay.textContent = `${monthNames[month]} ${year}`;

      dow.forEach(d => {
        const h = document.createElement('div');
        h.className = 'dow';
        h.textContent = d;
        calendar.appendChild(h);
      });

      const first = new Date(year, month, 1);
      const startOffset = first.getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();

      for (let i = 0; i < startOffset; i++) {
        const e = document.createElement('div');
        e.className = 'day empty';
        calendar.appendChild(e);
      }

      const today = new Date(); today.setHours(0,0,0,0);

      for (let day = 1; day <= daysInMonth; day++) {
        const cell = document.createElement('div');
        cell.className = 'day';
        const num = document.createElement('div');
        num.className = 'num';
        num.textContent = day;
        cell.appendChild(num);

        const thisDate = new Date(year, month, day);
        const key = ymd(thisDate);

        if (reservations[key]) {
          cell.classList.add('booked');
          const nameEl = document.createElement('div');
          nameEl.className = 'resv-name';
          nameEl.textContent = reservations[key].name;
          cell.appendChild(nameEl);
          cell.title = `محجوز بواسطة: ${reservations[key].name}`;
        } else {
          cell.classList.add('available');
          if (thisDate >= today) {
            cell.addEventListener('click', () => {
              const input = document.getElementById('checkin');
              input.value = key;
              document.getElementById('reserve').scrollIntoView({ behavior: 'smooth', block: 'start' });
            });
          } else {
            cell.classList.remove('available');
            cell.style.background = '#1c1c1c';
            cell.style.color = '#777';
            cell.style.cursor = 'not-allowed';
            cell.title = 'تاريخ قديم';
          }
        }
        if (ymd(thisDate) === ymd(today)) cell.classList.add('today');
        calendar.appendChild(cell);
      }
    }

    function showConfirmation(data) {
      const modal = document.getElementById('confirmationModal');
      const details = document.getElementById('bookingDetails');
      const checkinDate = new Date(data.checkin).toLocaleDateString();
      details.innerHTML = `<p><strong>الاسم:</strong> ${data.name}</p><p><strong>التاريخ:</strong> ${checkinDate}</p>`;
      modal.style.display = 'block';
    }
    function closeModal(){ document.getElementById('confirmationModal').style.display = 'none'; }

    function renderSearchResults(list){
      const resultsDiv = document.getElementById('reservationResults');
      if (!Object.keys(list).length) {
        resultsDiv.innerHTML = '<p style="color:#aaa">لا يوجد حجوزات بالاسم المدخل.</p>';
        return;
      }
      let html = '';
      Object.entries(list).forEach(([dateString, reservation]) => {
        const formatted = new Date(dateString).toLocaleDateString(undefined, { weekday:'long', year:'numeric', month:'long', day:'numeric' });
        html += `
          <div class="reservation-item">
            <div><strong>الاسم:</strong> ${reservation.name}</div>
            <div><strong>التاريخ:</strong> ${formatted}</div>
            <div class="actions"><button class="btn danger" onclick="cancelReservation('${dateString}')">إلغاء</button></div>
          </div>`;
      });
      resultsDiv.innerHTML = html;
    }

    window.cancelReservation = async function(dateString){
      if (!reservations[dateString]) return alert('لم يتم العثور على الحجز.');
      if (confirm('هل تريد إلغاء هذا الحجز؟')) {
        await deleteReservation(dateString);
        await fetchReservations();
        buildCalendar(current);
        document.getElementById('reservationResults').innerHTML = '<p style="color:#0f0">تم إلغاء الحجز.</p>';
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      await fetchReservations();
      const dateInput = document.getElementById('checkin');
      const todayStr = new Date().toISOString().split('T')[0];
      dateInput.min = todayStr;

      document.getElementById('prevBtn').addEventListener('click', async () => { current.setMonth(current.getMonth() - 1); buildCalendar(current); });
      document.getElementById('nextBtn').addEventListener('click', async () => { current.setMonth(current.getMonth() + 1); buildCalendar(current); });
      document.getElementById('todayBtn').addEventListener('click', async () => { current = new Date(); buildCalendar(current); });

      buildCalendar(current);

      document.getElementById('reservationForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const form = e.currentTarget;
        const name = form.name.value.trim();
        const checkin = form.checkin.value;
        if (!name || !checkin) return alert('الرجاء إكمال البيانات.');
        if (reservations[checkin]) return alert('هذا التاريخ محجوز بالفعل.');
        const resp = await createReservation(name, checkin);
        if (resp.error) return alert(resp.error);
        await fetchReservations();
        buildCalendar(current);
        showConfirmation({ name, checkin });
        form.reset();
      });

      document.getElementById('closeModalBtn').addEventListener('click', closeModal);
      window.addEventListener('click', (e) => { if (e.target.id === 'confirmationModal') closeModal(); });

      document.getElementById('searchBtn').addEventListener('click', async () => {
        const q = document.getElementById('searchName').value.trim();
        if (!q) return alert('أدخل اسم للبحث.');
        const found = await searchReservations(q);
        renderSearchResults(found);
      });
    });
  </script>
</body>
</html>
