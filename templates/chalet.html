<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ø§Ù„Ø¬ÙˆÙ‡Ø±Ø© - Chalet Reservation</title>
  <style>
    body {
      font-family: "Segoe UI", Roboto, sans-serif;
      background: #f9fafb;
      margin: 0;
      padding: 0;
      color: #1f2937;
    }

    header {
      background: white;
      color: #111827;
      padding: 1.5rem;
      text-align: center;
      border-bottom: 1px solid #e5e7eb;
    }

    header h1 {
      margin: 0;
      font-size: 1.8rem;
      font-weight: 700;
    }

    header p {
      margin: 0.25rem 0 0;
      font-size: 0.95rem;
      color: #6b7280;
    }

    .container {
      max-width: 900px;
      margin: 25px auto;
      padding: 24px;
      background: white;
      border-radius: 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }

    h2 {
      margin-bottom: 12px;
      color: #111827;
    }

    /* ===== Calendar ===== */
    #calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px;
      margin-top: 10px;
    }

    .dow {
      font-weight: bold;
      text-align: center;
      padding: 6px;
      color: #6b7280;
    }

    .day {
      padding: 12px;
      border-radius: 10px;
      min-height: 70px;
      text-align: center;
      font-size: 14px;
      border: 1px solid #e5e7eb;
      display: flex;
      flex-direction: column;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .day.empty {
      background: transparent;
      border: none;
      cursor: default;
    }

    .day.available {
      background: #f0fdf4; /* light green */
      border: 1px solid #bbf7d0;
      color: #166534;
    }

    .day.available:hover {
      background: #dcfce7; /* hover lighter green */
    }

    .day.booked {
      background: #fee2e2; /* light red */
      border: 1px solid #fecaca;
      color: #b91c1c;
      cursor: not-allowed;
    }

    .day.past {
      background: #f3f4f6; /* grey */
      color: #9ca3af;
      cursor: not-allowed;
    }

    .day.today {
      border: 2px solid #22c55e;
    }

    .num {
      font-weight: bold;
      font-size: 16px;
    }

    .resv-name {
      margin-top: 4px;
      font-size: 12px;
      color: #374151;
      font-weight: 500;
    }

    /* ===== Buttons ===== */
    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      transition: background 0.2s, transform 0.1s;
    }

    .btn:hover { transform: scale(1.05); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

    .btn.primary { background: #22c55e; color: white; }
    .btn.primary:hover:not(:disabled) { background: #16a34a; }

    .btn.danger { background: #ef4444; color: white; }
    .btn.danger:hover:not(:disabled) { background: #dc2626; }

    .btn.light { background: #f3f4f6; }
    .btn.light:hover:not(:disabled) { background: #e5e7eb; }

    .actions { display: flex; gap: 10px; margin-top: 12px; flex-wrap: wrap; }

    /* ===== Form ===== */
    .form-grid { display: grid; gap: 16px; margin-top: 10px; }
    input {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 15px;
      box-sizing: border-box;
    }
    input:focus {
      border-color: #22c55e;
      outline: none;
      box-shadow: 0 0 4px rgba(34,197,94,0.4);
    }

    .reservation-item {
      border: 1px solid #ddd;
      padding: 12px;
      margin-bottom: 10px;
      border-radius: 10px;
      background: #fafafa;
    }

    /* Legend */
    .legend {
      display: flex;
      gap: 16px;
      margin-top: 10px;
      font-size: 14px;
      color: #6b7280;
    }
    .legend span {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .legend .box {
      width: 16px;
      height: 16px;
      border-radius: 4px;
      display: inline-block;
    }
    .legend .available { background: #bbf7d0; }
    .legend .booked { background: #fecaca; }
    .legend .past { background: #e5e7eb; }

    .success-message {
      background: #d1fae5;
      border: 1px solid #a7f3d0;
      color: #065f46;
      padding: 12px;
      border-radius: 8px;
      margin-top: 12px;
    }

    .error-message {
      background: #fee2e2;
      border: 1px solid #fecaca;
      color: #991b1b;
      padding: 12px;
      border-radius: 8px;
      margin-top: 12px;
    }

    .loading {
      opacity: 0.6;
      pointer-events: none;
    }

  </style>
</head>
<body>
  <header>
    <h1>Ø§Ù„Ø¬ÙˆÙ‡Ø±Ø©</h1>
    <p>Simple booking for family</p>
  </header>

  <div class="container">
    <h2 id="monthDisplay"></h2>
    <p>Tap an <strong>Available</strong> day to pre-fill the reservation date.</p>
    <div class="actions">
      <button id="prevBtn" class="btn light">âŸµ Prev</button>
      <button id="todayBtn" class="btn primary">Today</button>
      <button id="nextBtn" class="btn light">Next âŸ¶</button>
      <button id="refreshBtn" class="btn light">ðŸ”„ Refresh</button>
    </div>
    <div id="calendar"></div>
    <div class="legend">
      <span><span class="box available"></span> Available</span>
      <span><span class="box booked"></span> Reserved</span>
      <span><span class="box past"></span> Past</span>
    </div>
  </div>

  <div class="container" id="reserve">
    <h2>Make a Reservation</h2>
    <p>We'll contact you within 24 hours to confirm.</p>
    <form id="reservationForm">
      <div class="form-grid">
        <div>
          <label for="name">Full Name *</label>
          <input type="text" id="name" name="name" required />
        </div>
        <div>
          <label for="checkin">Reservation Date *</label>
          <input type="date" id="checkin" name="checkin" required />
        </div>
      </div>
      <div class="actions">
        <button type="submit" class="btn primary" id="submitBtn">Submit Reservation</button>
        <button type="reset" class="btn light">Clear</button>
      </div>
    </form>
    <div id="reservationMessage"></div>
  </div>

  <div class="container">
    <h2>Manage Reservations</h2>
    <div class="form-grid">
      <input type="text" id="searchName" placeholder="Enter your name" />
      <button id="searchBtn" class="btn primary">Search</button>
    </div>
    <div id="reservationResults" style="margin-top:12px;"></div>
  </div>

  <script>
    const API_BASE = "https://chaletf.onrender.com";
    let reservations = {}; 
    let current = new Date();
    let isLoading = false;

    function setLoading(loading) {
      isLoading = loading;
      const elements = [
        document.getElementById('submitBtn'),
        document.getElementById('searchBtn'),
        document.getElementById('refreshBtn')
      ];
      
      elements.forEach(el => {
        if (el) el.disabled = loading;
      });
      
      if (loading) {
        document.body.classList.add('loading');
      } else {
        document.body.classList.remove('loading');
      }
    }

    function showMessage(message, isError = false) {
      const messageDiv = document.getElementById('reservationMessage');
      messageDiv.className = isError ? 'error-message' : 'success-message';
      messageDiv.textContent = message;
      setTimeout(() => {
        messageDiv.innerHTML = '';
        messageDiv.className = '';
      }, 5000);
    }

    async function fetchReservations() {
      try {
        setLoading(true);
        const res = await fetch(`${API_BASE}/api/reservations`);
        
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }
        
        const data = await res.json();
        reservations = data || {};
        
      } catch (err) {
        console.error("Error fetching reservations:", err);
        showMessage(`Failed to load reservations: ${err.message}`, true);
        reservations = {};
      } finally {
        setLoading(false);
      }
    }

    async function createReservation(name, date) {
      try {
        setLoading(true);
        const res = await fetch(`${API_BASE}/api/reservations`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name: name.trim(), date })
        });
        
        const result = await res.json();
        
        if (!res.ok) {
          throw new Error(result.error || `HTTP ${res.status}`);
        }
        
        return result;
      } catch (err) {
        console.error("Error creating reservation:", err);
        throw err;
      } finally {
        setLoading(false);
      }
    }

    async function deleteReservation(date) {
      try {
        setLoading(true);
        const res = await fetch(`${API_BASE}/api/reservations/${date}`, { 
          method: "DELETE" 
        });
        
        const result = await res.json();
        
        if (!res.ok) {
          throw new Error(result.error || `HTTP ${res.status}`);
        }
        
        return result;
      } catch (err) {
        console.error("Error deleting reservation:", err);
        throw err;
      } finally {
        setLoading(false);
      }
    }

    async function searchReservations(query) {
      try {
        setLoading(true);
        const res = await fetch(`${API_BASE}/api/reservations/search?name=${encodeURIComponent(query)}`);
        
        const result = await res.json();
        
        if (!res.ok) {
          throw new Error(result.error || `HTTP ${res.status}`);
        }
        
        return result;
      } catch (err) {
        console.error("Error searching reservations:", err);
        throw err;
      } finally {
        setLoading(false);
      }
    }

    function pad(n){ return String(n).padStart(2,'0'); }
    function ymd(d){ return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }

    function buildCalendar(date) {
      const calendar = document.getElementById('calendar');
      const monthDisplay = document.getElementById('monthDisplay');
      calendar.innerHTML = '';

      const year = date.getFullYear();
      const month = date.getMonth();
      const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
      const dow = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
      monthDisplay.textContent = `${monthNames[month]} ${year}`;

      dow.forEach(d => {
        const h = document.createElement('div');
        h.className = 'dow';
        h.textContent = d;
        calendar.appendChild(h);
      });

      const first = new Date(year, month, 1);
      const startOffset = first.getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();

      for (let i = 0; i < startOffset; i++) {
        const e = document.createElement('div');
        e.className = 'day empty';
        calendar.appendChild(e);
      }

      const today = new Date(); 
      today.setHours(0,0,0,0);

      for (let day = 1; day <= daysInMonth; day++) {
        const cell = document.createElement('div');
        cell.className = 'day';
        const num = document.createElement('div');
        num.className = 'num';
        num.textContent = day;
        cell.appendChild(num);

        const thisDate = new Date(year, month, day);
        const key = ymd(thisDate);

        if (thisDate < today) {
          cell.classList.add('past');
        } else if (reservations[key] && reservations[key].name) {
          cell.classList.add('booked');
          const nameEl = document.createElement('div');
          nameEl.className = 'resv-name';
          nameEl.textContent = reservations[key].name;
          cell.appendChild(nameEl);
          cell.title = `Reserved by: ${reservations[key].name}`;
        } else {
          cell.classList.add('available');
          cell.addEventListener('click', () => {
            const input = document.getElementById('checkin');
            input.value = key;
            document.getElementById('reserve').scrollIntoView({ behavior: 'smooth', block: 'start' });
          });
        }
        if (ymd(thisDate) === ymd(today)) cell.classList.add('today');
        calendar.appendChild(cell);
      }
    }

    function renderSearchResults(list){
      const resultsDiv = document.getElementById('reservationResults');
      if (!list || !Object.keys(list).length) {
        resultsDiv.innerHTML = '<p style="color:#6b7280">No reservations found for this name.</p>';
        return;
      }
      let html = '';
      Object.entries(list).forEach(([dateString, reservation]) => {
        const formatted = new Date(dateString + 'T00:00:00').toLocaleDateString(undefined, { 
          weekday:'long', 
          year:'numeric', 
          month:'long', 
          day:'numeric' 
        });
        html += `
          <div class="reservation-item">
            <div><strong>Name:</strong> ${reservation.name}</div>
            <div><strong>Date:</strong> ${formatted}</div>
            <div class="actions"><button class="btn danger" onclick="cancelReservation('${dateString}')">Cancel</button></div>
          </div>`;
      });
      resultsDiv.innerHTML = html;
    }

    window.cancelReservation = async function(dateString){
      if (!reservations[dateString]) {
        alert('Reservation not found.');
        return;
      }
      if (confirm('Cancel this reservation?')) {
        try {
          await deleteReservation(dateString);
          
          // Refresh data from server
          await fetchReservations();
          buildCalendar(current);
          
          document.getElementById('reservationResults').innerHTML = '<p style="color:#16a34a">Reservation cancelled successfully.</p>';
        } catch (err) {
          alert(`Error cancelling reservation: ${err.message}`);
        }
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      // Initial load
      await fetchReservations();
      
      const dateInput = document.getElementById('checkin');
      const todayStr = new Date().toISOString().split('T')[0];
      dateInput.min = todayStr;

      // Navigation buttons
      document.getElementById('prevBtn').addEventListener('click', () => { 
        current.setMonth(current.getMonth() - 1); 
        buildCalendar(current); 
      });
      
      document.getElementById('nextBtn').addEventListener('click', () => { 
        current.setMonth(current.getMonth() + 1); 
        buildCalendar(current); 
      });
      
      document.getElementById('todayBtn').addEventListener('click', () => { 
        current = new Date(); 
        buildCalendar(current); 
      });

      // Refresh button
      document.getElementById('refreshBtn').addEventListener('click', async () => {
        await fetchReservations();
        buildCalendar(current);
        showMessage('Calendar refreshed!');
      });

      buildCalendar(current);

      // Form submission
      document.getElementById('reservationForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const form = e.currentTarget;
        const name = form.name.value.trim();
        const checkin = form.checkin.value;
        
        if (!name || !checkin) {
          showMessage('Please complete the form.', true);
          return;
        }
        
        if (reservations[checkin]) {
          showMessage('This date is already reserved.', true);
          return;
        }
        
        try {
          const resp = await createReservation(name, checkin);
          
          if (resp && resp.error) {
            showMessage(resp.error, true);
            return;
          }
          
          // Refresh data from server to ensure consistency
          await fetchReservations();
          buildCalendar(current);
          form.reset();
          showMessage('Reservation created successfully!');
          
        } catch (err) {
          console.error('Error in form submission:', err);
          showMessage(`Error creating reservation: ${err.message}`, true);
        }
      });

      // Search functionality
      document.getElementById('searchBtn').addEventListener('click', async () => {
        const q = document.getElementById('searchName').value.trim();
        if (!q) {
          alert('Please enter a name to search.');
          return;
        }
        try {
          const found = await searchReservations(q);
          renderSearchResults(found);
        } catch (err) {
          document.getElementById('reservationResults').innerHTML = 
            `<p style="color:#ef4444">Search error: ${err.message}</p>`;
        }
      });

      // Search on Enter key
      document.getElementById('searchName').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          document.getElementById('searchBtn').click();
        }
      });
    });
  </script>
</body>
</html>
